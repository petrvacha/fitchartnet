#!/bin/sh
# This script is a Git pre-commit hook that runs ECS, PHPStan, and tests.
# It automatically formats code and checks for issues before committing (including amend).
# All checks (ECS, PHPStan, tests) run only when PHP files are changed.
# If you want to skip the hook, set the environment variable SKIP_GIT_HOOKS to any value.

if [ -n "$SKIP_GIT_HOOKS" ]; then
    echo "Skipping pre-commit hook because SKIP_GIT_HOOKS is set."
    exit 0
fi

changed_files=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')

# Check if Docker container is running
if ! docker ps --format '{{.Names}}' | grep -q '^fitchartnet$'; then
    echo "Docker container 'fitchartnet' is not running."
    echo "Start it with: make up"
    exit 1
fi

# Run checks only if PHP files are changed
if [ -n "$changed_files" ]; then
    echo "Running ECS (Easy Coding Standard)..."
    if ! docker exec fitchartnet vendor/bin/ecs check --fix; then
        echo "ECS found issues that could not be automatically fixed."
        exit 1
    fi

    # Re-add files that were fixed by ECS
    echo "$changed_files" | xargs git add

    echo "Running PHPStan..."
    if ! docker exec fitchartnet vendor/bin/phpstan analyse --memory-limit=512M; then
        echo "PHPStan found issues. Please fix them before committing."
        exit 1
    fi

    echo "Running tests..."
    if ! docker exec fitchartnet vendor/bin/tester -C tests; then
        echo "Tests failed. Please fix them before committing."
        exit 1
    fi
else
    echo "No PHP files changed, skipping all checks."
    exit 0
fi

echo "All checks passed."
exit 0
